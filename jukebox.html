<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Jukebox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link href="https://api.fontshare.com/v2/css?f[]=satoshi@400,500,700&f[]=clash-grotesk@600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Shade&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <style>
        :root {
            --purple-deep: #0a0510;
            --purple-mid: #160d21;
            --neon-coral: #ff5e62;
            --retro-gold: #f5d142;
        }
        body {
            font-family: 'Satoshi', sans-serif;
            background-color: var(--purple-deep);
            color: #fff;
        }
        .font-display { font-family: 'Clash Grotesk', sans-serif; }
        .font-arcade { font-family: 'Bungee Shade', cursive; }
        .glass-card {
            background: rgba(22, 13, 33, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .neon-border-coral {
            border: 1px solid rgba(255, 94, 98, 0.3);
            box-shadow: 0 0 15px rgba(255, 94, 98, 0.1);
        }
        .neon-text-coral {
            color: var(--neon-coral);
            text-shadow: 0 0 10px rgba(255, 94, 98, 0.5);
        }
        .neon-text-gold {
            color: var(--retro-gold);
            text-shadow: 0 0 10px rgba(245, 209, 66, 0.5);
        }
        @keyframes pulse-glow {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .animate-pulse-glow { animation: pulse-glow 3s ease-in-out infinite; }
        @keyframes vinylSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 94, 98, 0.3); border-radius: 10px; }

        /* Search modal overlay */
        .search-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 5, 16, 0.85);
            backdrop-filter: blur(8px);
            z-index: 50;
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 80px;
        }
        .search-overlay.active { display: flex; }
        .search-modal {
            width: 90%;
            max-width: 640px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        /* Toast notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .toast {
            background: rgba(22, 13, 33, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: toastIn 0.3s ease;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 360px;
            font-size: 0.85rem;
        }
        .toast.toast-out { animation: toastOut 0.3s ease forwards; }
        .toast-success { border-left: 3px solid #4ecdc4; }
        .toast-error { border-left: 3px solid var(--neon-coral); }
        .toast-info { border-left: 3px solid var(--retro-gold); }
        @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
        @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

        /* Invite popover */
        .invite-popover {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            z-index: 60;
            display: none;
        }
        .invite-popover.active { display: block; }
    </style>
</head>
<body>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Main Layout -->
<div class="min-h-screen flex flex-col bg-[radial-gradient(circle_at_top_right,_#1a0b2e_0%,_#0a0510_100%)] p-4 lg:p-6 gap-4 lg:gap-6">

    <!-- ===== HEADER ===== -->
    <header class="flex items-center justify-between px-4 lg:px-8 h-16 glass-card rounded-2xl neon-border-coral flex-shrink-0">
        <div class="flex items-center gap-6">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-[#ff5e62] to-[#f5d142] rounded-lg flex items-center justify-center shadow-[0_0_15px_rgba(255,94,98,0.4)]">
                    <iconify-icon icon="lucide:music" class="text-white text-xl"></iconify-icon>
                </div>
                <h1 class="text-xl lg:text-2xl font-display font-semibold tracking-tight neon-text-gold">PARTY<span class="text-white">JUKEBOX</span></h1>
            </div>
            <div class="hidden md:flex items-center gap-4 border-l border-white/10 pl-6">
                <div class="flex items-center gap-2 px-3 py-1 bg-black/40 rounded-full border border-[#ff5e62]/20">
                    <span class="flex h-2 w-2 relative">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-[#ff5e62] opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-[#ff5e62]"></span>
                    </span>
                    <p class="text-[#ff5e62] text-[10px] uppercase font-bold tracking-widest">Session Live</p>
                </div>
                <p class="text-xs text-gray-400">
                    <iconify-icon icon="lucide:list-music" class="inline mr-1"></iconify-icon>
                    <span id="header-queue-count">0</span> in queue
                </p>
            </div>
        </div>
        <div class="flex items-center gap-3 relative">
            <button id="invite-btn" onclick="toggleInvite()" class="bg-[#ff5e62] hover:bg-[#ff7e81] text-white px-4 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 shadow-[0_0_15px_rgba(255,94,98,0.3)]">
                <iconify-icon icon="lucide:user-plus"></iconify-icon> INVITE
            </button>
            <!-- Invite Popover -->
            <div id="invite-popover" class="invite-popover">
                <div class="glass-card rounded-2xl p-6 border border-[#f5d142]/20 w-72 shadow-2xl">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-sm font-display font-semibold neon-text-gold">Invite Guests</p>
                        <button onclick="toggleInvite()" class="text-gray-400 hover:text-white"><iconify-icon icon="lucide:x" class="text-lg"></iconify-icon></button>
                    </div>
                    <div class="flex justify-center mb-4">
                        <div class="bg-white rounded-xl p-3">
                            <div id="qrcode"></div>
                        </div>
                    </div>
                    <p class="text-center text-[10px] text-gray-400 mb-4">Scan to join the party from any device</p>
                    <div class="flex gap-2">
                        <input type="text" id="invite-url-display" readonly class="flex-1 bg-black/40 border border-white/10 rounded-lg py-2 px-3 text-[11px] text-gray-300 font-mono truncate">
                        <button onclick="copyInviteUrl()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-2 rounded-lg text-xs transition-all flex items-center gap-1">
                            <iconify-icon icon="lucide:copy"></iconify-icon>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="flex-1 flex flex-col lg:flex-row gap-4 lg:gap-6 overflow-hidden min-h-0">

        <!-- LEFT: Queue Panel -->
        <section class="lg:w-1/4 flex flex-col gap-4 lg:gap-6 lg:h-full order-3 lg:order-1">
            <div class="glass-card rounded-3xl p-5 lg:p-6 flex-1 flex flex-col overflow-hidden">
                <div class="flex items-center justify-between mb-4 lg:mb-6">
                    <h3 class="font-display text-white text-lg flex items-center gap-2">
                        <iconify-icon icon="lucide:list-music" class="text-[#ff5e62]"></iconify-icon> QUEUE
                    </h3>
                    <span class="text-[10px] text-gray-500 font-bold uppercase tracking-widest"><span id="queue-count">0</span> Tracks</span>
                </div>
                <div class="flex-1 overflow-y-auto space-y-3 pr-1 min-h-0" id="queue-container">
                    <div class="text-center py-10 text-gray-500 text-sm">Queue is empty</div>
                </div>
                <button onclick="openSearch()" class="mt-4 lg:mt-6 w-full py-3 bg-white/5 hover:bg-white/10 rounded-2xl border border-white/10 text-xs font-bold text-gray-300 flex items-center justify-center gap-2 transition-all">
                    <iconify-icon icon="lucide:search"></iconify-icon> SEARCH & ADD SONGS
                </button>
            </div>
        </section>

        <!-- CENTER: Now Playing / Video -->
        <section class="flex-1 flex flex-col gap-4 lg:gap-6 order-1 lg:order-2">
            <div class="glass-card rounded-[32px] overflow-hidden flex flex-col neon-border-coral shadow-2xl flex-1">
                <div class="p-4 lg:p-6 xl:p-8 flex flex-col gap-4 lg:gap-6 flex-1">
                    <!-- Video Player -->
                    <div id="video-container" class="relative bg-black/80 rounded-3xl overflow-hidden" style="aspect-ratio: 16/9;">
                        <!-- Empty state -->
                        <div id="empty-player" class="absolute inset-0 flex flex-col items-center justify-center">
                            <div class="w-20 h-20 rounded-full border-4 border-[#ff5e62]/30 flex items-center justify-center bg-black/40 backdrop-blur-md mb-4">
                                <iconify-icon icon="lucide:music" class="text-[#ff5e62] text-4xl"></iconify-icon>
                            </div>
                            <p class="text-gray-400 text-sm">No song playing. Add one to get started!</p>
                        </div>
                        <!-- YouTube iframe (hidden until playing) -->
                        <iframe
                            id="youtube-player"
                            class="absolute inset-0 w-full h-full hidden"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen
                        ></iframe>
                    </div>

                    <!-- Now Playing Info -->
                    <div id="now-playing-info" class="hidden">
                        <div class="flex flex-col md:flex-row items-start md:items-end justify-between gap-4">
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="px-2 py-0.5 bg-[#ff5e62]/20 text-[#ff5e62] rounded text-[10px] font-black uppercase tracking-widest border border-[#ff5e62]/30">Now Playing</span>
                                </div>
                                <h2 id="now-playing-title" class="text-2xl lg:text-4xl font-display font-bold text-white tracking-tight leading-none"></h2>
                            </div>
                            <div class="flex items-center gap-3">
                                <button onclick="skipSong()" class="flex items-center gap-2 px-4 py-2 bg-white/5 hover:bg-white/10 rounded-2xl border border-white/10 text-white text-sm font-semibold transition-all">
                                    <iconify-icon icon="lucide:skip-forward"></iconify-icon> Skip
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- RIGHT: Chat + QR + Add Song -->
        <section class="lg:w-1/4 flex flex-col gap-4 lg:gap-6 lg:h-full order-2 lg:order-3">

            <!-- Chat Panel -->
            <div class="glass-card rounded-3xl p-5 lg:p-6 flex-1 flex flex-col overflow-hidden">
                <h3 class="font-display text-white text-lg mb-4 flex items-center gap-2">
                    <iconify-icon icon="lucide:message-square" class="text-[#f5d142]"></iconify-icon> CHAT
                </h3>
                <div id="chat-messages" class="flex-1 overflow-y-auto space-y-3 pr-1 min-h-0 text-sm">
                    <div class="text-center py-6 text-gray-500 text-xs">No messages yet. Say something!</div>
                </div>
                <div class="mt-3 flex flex-col gap-2">
                    <div class="flex items-center gap-1.5">
                        <span class="text-[9px] text-gray-500 uppercase tracking-widest">Chatting as</span>
                        <button id="chat-name-btn" onclick="editChatName()" class="text-[11px] font-bold text-[#f5d142] hover:text-[#ffe066] transition-colors truncate max-w-[120px]"></button>
                        <iconify-icon icon="lucide:pencil" class="text-[10px] text-gray-600 cursor-pointer hover:text-gray-400 transition-colors" onclick="editChatName()"></iconify-icon>
                    </div>
                    <div id="chat-name-editor" class="hidden flex gap-2">
                        <input
                            type="text"
                            id="chat-name-input"
                            maxlength="20"
                            placeholder="Enter your name..."
                            onkeypress="if(event.key === 'Enter') saveChatName()"
                            class="flex-1 bg-black/40 border border-[#f5d142]/30 rounded-xl py-2 px-3 text-xs text-white placeholder-gray-500 focus:outline-none focus:border-[#f5d142]/60 transition-colors"
                        >
                        <button onclick="saveChatName()" class="bg-[#f5d142] hover:bg-[#ffe066] text-black px-3 py-2 rounded-xl text-xs font-bold transition-all">Save</button>
                    </div>
                    <div id="chat-input-row" class="flex gap-2">
                        <input
                            type="text"
                            id="chat-input"
                            placeholder="Say something..."
                            onkeypress="if(event.key === 'Enter') sendChat()"
                            class="flex-1 bg-black/40 border border-white/10 rounded-xl py-2.5 px-3 text-xs text-white placeholder-gray-500 focus:outline-none focus:border-[#ff5e62]/50 transition-colors"
                        >
                        <button onclick="sendChat()" class="bg-[#ff5e62] hover:bg-[#ff7e81] text-white px-3 py-2.5 rounded-xl text-xs font-bold transition-all flex items-center gap-1">
                            <iconify-icon icon="lucide:send" class="text-sm"></iconify-icon>
                        </button>
                    </div>
                </div>
            </div>

            <!-- QR + Add Song (compact) -->
            <div class="glass-card rounded-3xl p-5 lg:p-6 flex flex-col gap-4 flex-shrink-0">
                <div class="flex items-center gap-4">
                    <div class="bg-white rounded-lg p-2 flex-shrink-0">
                        <div id="qrcode-sidebar"></div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <p class="text-[10px] font-display text-[#f5d142] uppercase tracking-widest">Scan to Join</p>
                        <p class="text-[10px] text-gray-500 mt-1">Add songs from your phone</p>
                    </div>
                </div>

                <!-- Inline search -->
                <div class="relative">
                    <iconify-icon icon="lucide:search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm"></iconify-icon>
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Search for a song..."
                        onkeypress="if(event.key === 'Enter') searchSongs()"
                        class="w-full bg-black/40 border border-white/10 rounded-xl py-2.5 pl-10 pr-4 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-[#ff5e62]/50 transition-colors"
                    >
                </div>
                <button onclick="searchSongs()" id="search-btn" class="w-full py-2.5 bg-[#ff5e62] hover:bg-[#ff7e81] text-white rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 shadow-[0_0_10px_rgba(255,94,98,0.2)]">
                    <iconify-icon icon="lucide:search"></iconify-icon> SEARCH
                </button>

                <!-- Search Results (inline) -->
                <div id="search-results" class="hidden overflow-y-auto max-h-48 space-y-2">
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Results</p>
                    <div id="results-container"></div>
                </div>

                <!-- URL Paste -->
                <div class="pt-3 border-t border-white/5">
                    <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2">Or paste a YouTube URL</p>
                    <div class="flex gap-2">
                        <input
                            type="text"
                            id="url-input"
                            placeholder="https://youtube.com/watch?v=..."
                            onkeypress="if(event.key === 'Enter') addSongFromUrl()"
                            class="flex-1 bg-black/40 border border-white/10 rounded-xl py-2.5 px-3 text-xs text-white placeholder-gray-500 focus:outline-none focus:border-[#ff5e62]/50 transition-colors"
                        >
                        <button onclick="addSongFromUrl()" class="bg-[#4ecdc4] hover:bg-[#5eddd4] text-white px-3 py-2.5 rounded-xl text-xs font-bold transition-all">Add</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- ===== FOOTER ===== -->
    <footer class="h-16 glass-card rounded-2xl flex items-center justify-between px-4 lg:px-8 border-t border-white/5 flex-shrink-0">
        <div class="flex items-center gap-4 lg:gap-8">
            <div class="flex items-center gap-3 lg:gap-4">
                <button onclick="skipSong()" class="text-gray-400 hover:text-white transition-colors">
                    <iconify-icon icon="lucide:skip-forward" class="text-xl"></iconify-icon>
                </button>
            </div>
            <div class="hidden md:flex items-center gap-3 border-l border-white/10 pl-4 lg:pl-8">
                <div id="footer-vinyl" class="w-8 h-8 rounded-full bg-gradient-radial hidden" style="background: radial-gradient(circle, #1a1a1a 35%, #f5d142 36%, #f5d142 38%, #1a1a1a 39%, #1a1a1a 48%, #333 49%); animation: vinylSpin 3s linear infinite;"></div>
                <div class="text-sm">
                    <p id="footer-title" class="text-white font-semibold truncate max-w-[200px] lg:max-w-[300px]">No song playing</p>
                    <p id="footer-status" class="text-[10px] text-gray-500">Waiting for songs...</p>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-4 lg:gap-6">
            <div class="text-right hidden sm:block">
                <p class="text-[9px] text-gray-500 font-display uppercase tracking-widest">Status</p>
                <p id="footer-connection" class="text-xs text-green-500 font-mono">CONNECTED</p>
            </div>
        </div>
    </footer>
</div>

<!-- ===== SEARCH OVERLAY (for mobile / full-screen search) ===== -->
<div id="search-overlay" class="search-overlay" onclick="if(event.target===this)closeSearch()">
    <div class="search-modal glass-card rounded-3xl p-6 neon-border-coral">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-display text-white text-lg flex items-center gap-2">
                <iconify-icon icon="lucide:search" class="text-[#ff5e62]"></iconify-icon> Search Songs
            </h3>
            <button onclick="closeSearch()" class="text-gray-400 hover:text-white"><iconify-icon icon="lucide:x" class="text-xl"></iconify-icon></button>
        </div>
        <div class="relative mb-4">
            <iconify-icon icon="lucide:search" class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm"></iconify-icon>
            <input
                type="text"
                id="overlay-search-input"
                placeholder="Search for a song..."
                onkeypress="if(event.key === 'Enter') overlaySearch()"
                class="w-full bg-black/40 border border-white/10 rounded-xl py-3 pl-10 pr-4 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-[#ff5e62]/50 transition-colors"
            >
        </div>
        <button onclick="overlaySearch()" id="overlay-search-btn" class="w-full py-3 bg-[#ff5e62] hover:bg-[#ff7e81] text-white rounded-xl text-xs font-bold transition-all flex items-center justify-center gap-2 shadow-[0_0_10px_rgba(255,94,98,0.2)] mb-4">
            <iconify-icon icon="lucide:search"></iconify-icon> SEARCH
        </button>
        <div id="overlay-results" class="overflow-y-auto max-h-[50vh] space-y-2"></div>

        <div class="mt-4 pt-4 border-t border-white/5">
            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-2">Or paste a YouTube URL</p>
            <div class="flex gap-2">
                <input type="text" id="overlay-url-input" placeholder="https://youtube.com/watch?v=..." onkeypress="if(event.key === 'Enter') overlayAddUrl()" class="flex-1 bg-black/40 border border-white/10 rounded-xl py-2.5 px-3 text-xs text-white placeholder-gray-500 focus:outline-none focus:border-[#ff5e62]/50 transition-colors">
                <button onclick="overlayAddUrl()" class="bg-[#4ecdc4] hover:bg-[#5eddd4] text-white px-3 py-2.5 rounded-xl text-xs font-bold transition-all">Add</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ===== State =====
    let queue = [];
    let currentSong = null;
    let player = null;
    let qrGenerated = false;
    let serverIP = null;
    let serverPort = null;
    let syncInterval = null;
    let syncFailCount = 0;

    // Chat state
    let lastChatId = 0;
    let chatPollInterval = null;
    let chatUserName = sessionStorage.getItem('chatName') || ('Guest ' + Math.floor(Math.random() * 9000 + 1000));

    // ===== Utilities =====
    function escapeHtml(text) {
        if (text == null) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        const icons = { success: '&#10003;', error: '&#10007;', info: '&#9432;' };
        toast.innerHTML = '<span>' + (icons[type] || icons.info) + '</span><span>' + escapeHtml(message) + '</span>';
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('toast-out');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ===== Server Communication =====
    async function getServerIP() {
        try {
            const response = await fetch('/api/server-ip');
            const data = await response.json();
            serverIP = data.ip;
            serverPort = data.port;
            console.log('Server IP detected:', serverIP);
            return serverIP;
        } catch (error) {
            console.error('Failed to get server IP:', error);
            serverIP = window.location.hostname;
            serverPort = window.location.port || '8000';
            return serverIP;
        }
    }

    async function syncWithServer() {
        try {
            const response = await fetch('/api/state');
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) return;
            if (!response.ok) return;

            const serverState = await response.json();

            // Reset fail count on success
            if (syncFailCount > 0) {
                syncFailCount = 0;
                document.getElementById('footer-connection').textContent = 'CONNECTED';
                document.getElementById('footer-connection').className = 'text-xs text-green-500 font-mono';
            }

            const shouldAutoPlay = !currentSong && !serverState.currentSong && serverState.queue && serverState.queue.length > 0;

            queue = serverState.queue || [];

            const serverCurrentSong = serverState.currentSong;
            if (JSON.stringify(currentSong) !== JSON.stringify(serverCurrentSong)) {
                currentSong = serverCurrentSong;
                if (currentSong) {
                    displayCurrentSong();
                } else {
                    hidePlayer();
                }
            }

            if (shouldAutoPlay) {
                const firstSong = queue.shift();
                playSong(firstSong);
            }

            updateQueue();
        } catch (error) {
            syncFailCount++;
            if (syncFailCount >= 3) {
                document.getElementById('footer-connection').textContent = 'RECONNECTING...';
                document.getElementById('footer-connection').className = 'text-xs text-red-400 font-mono';
            }
            console.debug('Sync error:', error.message);
        }
    }

    async function pushToServer() {
        try {
            await fetch('/api/state', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ queue: queue, currentSong: currentSong })
            });
        } catch (error) {
            console.error('Push to server failed:', error);
        }
    }

    function startSync() {
        syncInterval = setInterval(syncWithServer, 2000);
    }

    // ===== QR Code =====
    async function generateQR() {
        if (qrGenerated) return;
        if (!serverIP) await getServerIP();

        const ip = serverIP || window.location.hostname;
        const port = serverPort || window.location.port || '8000';
        const qrUrl = 'http://' + ip + ':' + port + '/jukebox.html';

        // Sidebar QR
        const sidebarEl = document.getElementById('qrcode-sidebar');
        if (sidebarEl) {
            new QRCode(sidebarEl, { text: qrUrl, width: 120, height: 120, colorDark: '#000', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
        }

        // Invite popover QR
        const inviteEl = document.getElementById('qrcode');
        if (inviteEl) {
            new QRCode(inviteEl, { text: qrUrl, width: 160, height: 160, colorDark: '#000', colorLight: '#fff', correctLevel: QRCode.CorrectLevel.H });
        }

        // Invite URL display
        document.getElementById('invite-url-display').value = qrUrl;

        qrGenerated = true;
    }

    function toggleInvite() {
        const popover = document.getElementById('invite-popover');
        popover.classList.toggle('active');
    }

    function copyInviteUrl() {
        const url = document.getElementById('invite-url-display').value;
        navigator.clipboard.writeText(url).then(() => {
            showToast('Invite link copied!', 'success');
        }).catch(() => {
            // Fallback
            document.getElementById('invite-url-display').select();
            document.execCommand('copy');
            showToast('Invite link copied!', 'success');
        });
    }

    // Close invite popover when clicking outside
    document.addEventListener('click', function(e) {
        const popover = document.getElementById('invite-popover');
        const btn = document.getElementById('invite-btn');
        if (popover.classList.contains('active') && !popover.contains(e.target) && !btn.contains(e.target)) {
            popover.classList.remove('active');
        }
    });

    // ===== YouTube Player =====
    function onYouTubeIframeAPIReady() {
        console.log('YouTube API ready');
    }

    function displayCurrentSong() {
        if (!currentSong) return;

        const iframe = document.getElementById('youtube-player');
        const emptyPlayer = document.getElementById('empty-player');
        const nowPlayingInfo = document.getElementById('now-playing-info');
        const titleEl = document.getElementById('now-playing-title');
        const footerTitle = document.getElementById('footer-title');
        const footerStatus = document.getElementById('footer-status');
        const footerVinyl = document.getElementById('footer-vinyl');

        iframe.classList.remove('hidden');
        emptyPlayer.classList.add('hidden');
        nowPlayingInfo.classList.remove('hidden');

        const title = currentSong.title || 'Playing...';
        titleEl.textContent = title;
        footerTitle.textContent = title;
        footerStatus.textContent = 'Now playing';
        footerVinyl.classList.remove('hidden');

        const newSrc = 'https://www.youtube.com/embed/' + currentSong.videoId + '?autoplay=1&enablejsapi=1';
        iframe.src = newSrc;

        setTimeout(() => {
            if (window.YT && window.YT.Player) {
                player = new YT.Player('youtube-player', {
                    events: { 'onStateChange': onPlayerStateChange }
                });
            }
        }, 1000);
    }

    function hidePlayer() {
        document.getElementById('youtube-player').classList.add('hidden');
        document.getElementById('youtube-player').src = '';
        document.getElementById('empty-player').classList.remove('hidden');
        document.getElementById('now-playing-info').classList.add('hidden');
        document.getElementById('footer-title').textContent = 'No song playing';
        document.getElementById('footer-status').textContent = 'Waiting for songs...';
        document.getElementById('footer-vinyl').classList.add('hidden');
    }

    function onPlayerStateChange(event) {
        if (event.data === 0) {
            skipSong();
        }
    }

    function playSong(song) {
        currentSong = song;
        pushToServer();
        displayCurrentSong();
        updateQueue();
    }

    function skipSong() {
        if (queue.length > 0) {
            const nextSong = queue.shift();
            playSong(nextSong);
        } else {
            currentSong = null;
            pushToServer();
            hidePlayer();
            updateQueue();
        }
    }

    // ===== Search =====
    async function searchSongs() {
        const searchInput = document.getElementById('search-input');
        const query = searchInput.value.trim();
        const searchBtn = document.getElementById('search-btn');
        const resultsContainer = document.getElementById('results-container');
        const searchResults = document.getElementById('search-results');

        if (!query) {
            showToast('Please enter a search term', 'error');
            return;
        }

        searchBtn.innerHTML = '<iconify-icon icon="lucide:loader-2" class="animate-spin"></iconify-icon> Searching...';
        searchBtn.disabled = true;

        try {
            const response = await fetch('/api/search?q=' + encodeURIComponent(query));
            const results = await response.json();

            if (results.length > 0) {
                resultsContainer.innerHTML = '';
                results.forEach(function(result) {
                    const div = document.createElement('div');
                    div.className = 'group flex items-center gap-3 p-2.5 rounded-xl bg-white/5 border border-white/5 hover:border-[#ff5e62]/30 transition-all cursor-pointer';
                    div.dataset.videoId = result.videoId;
                    div.dataset.title = result.title;
                    div.addEventListener('click', function() {
                        addSongFromSearch(this.dataset.videoId, this.dataset.title);
                    });

                    const img = document.createElement('img');
                    img.src = result.thumbnail;
                    img.alt = result.title;
                    img.className = 'w-12 h-12 rounded-lg object-cover flex-shrink-0';

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'flex-1 min-w-0';

                    const titleDiv = document.createElement('h4');
                    titleDiv.className = 'text-xs text-white font-semibold truncate';
                    titleDiv.textContent = result.title;

                    const channelDiv = document.createElement('p');
                    channelDiv.className = 'text-[10px] text-gray-400 truncate';
                    channelDiv.textContent = result.channelTitle;

                    const addIcon = document.createElement('iconify-icon');
                    addIcon.setAttribute('icon', 'lucide:plus');
                    addIcon.className = 'text-gray-500 group-hover:text-[#ff5e62] transition-colors flex-shrink-0';

                    infoDiv.appendChild(titleDiv);
                    infoDiv.appendChild(channelDiv);
                    div.appendChild(img);
                    div.appendChild(infoDiv);
                    div.appendChild(addIcon);
                    resultsContainer.appendChild(div);
                });
                searchResults.classList.remove('hidden');
            } else {
                showToast('No results found. Try different keywords.', 'info');
            }
        } catch (error) {
            console.error('Search failed:', error);
            showToast('Search failed. Try again or paste a URL.', 'error');
        }

        searchBtn.innerHTML = '<iconify-icon icon="lucide:search"></iconify-icon> SEARCH';
        searchBtn.disabled = false;
    }

    // Overlay search (mobile full-screen)
    function openSearch() {
        document.getElementById('search-overlay').classList.add('active');
        document.getElementById('overlay-search-input').focus();
    }
    function closeSearch() {
        document.getElementById('search-overlay').classList.remove('active');
    }

    async function overlaySearch() {
        const input = document.getElementById('overlay-search-input');
        const query = input.value.trim();
        const btn = document.getElementById('overlay-search-btn');
        const resultsEl = document.getElementById('overlay-results');

        if (!query) { showToast('Please enter a search term', 'error'); return; }

        btn.innerHTML = '<iconify-icon icon="lucide:loader-2" class="animate-spin"></iconify-icon> Searching...';
        btn.disabled = true;

        try {
            const response = await fetch('/api/search?q=' + encodeURIComponent(query));
            const results = await response.json();
            resultsEl.innerHTML = '';

            if (results.length > 0) {
                results.forEach(function(result) {
                    const div = document.createElement('div');
                    div.className = 'group flex items-center gap-3 p-3 rounded-xl bg-white/5 border border-white/5 hover:border-[#ff5e62]/30 transition-all cursor-pointer';
                    div.addEventListener('click', function() {
                        addSongFromSearch(result.videoId, result.title);
                        closeSearch();
                    });

                    div.innerHTML = '<img src="' + escapeHtml(result.thumbnail) + '" class="w-14 h-14 rounded-xl object-cover flex-shrink-0">'
                        + '<div class="flex-1 min-w-0"><h4 class="text-sm text-white font-semibold truncate">' + escapeHtml(result.title) + '</h4>'
                        + '<p class="text-[10px] text-gray-400 truncate">' + escapeHtml(result.channelTitle) + '</p></div>'
                        + '<iconify-icon icon="lucide:plus" class="text-gray-500 group-hover:text-[#ff5e62] transition-colors flex-shrink-0 text-xl"></iconify-icon>';
                    resultsEl.appendChild(div);
                });
            } else {
                showToast('No results found.', 'info');
            }
        } catch (error) {
            showToast('Search failed.', 'error');
        }

        btn.innerHTML = '<iconify-icon icon="lucide:search"></iconify-icon> SEARCH';
        btn.disabled = false;
    }

    function overlayAddUrl() {
        const input = document.getElementById('overlay-url-input');
        const url = input.value.trim();
        const videoId = extractVideoId(url);
        if (videoId) {
            const song = { id: Date.now(), videoId: videoId, title: 'Video ' + videoId, addedAt: new Date().toLocaleTimeString() };
            // Try fetching title
            fetch('/api/video-info?id=' + videoId).then(r => r.json()).then(data => {
                if (data.title) song.title = data.title;
            }).catch(() => {}).finally(() => {
                queue.push(song);
                input.value = '';
                if (!currentSong) { playSong(song); } else { updateQueue(); pushToServer(); }
                showToast('"' + song.title + '" added!', 'success');
                closeSearch();
            });
        } else {
            showToast('Invalid YouTube URL', 'error');
        }
    }

    // ===== Add Songs =====
    function addSongFromSearch(videoId, title) {
        const song = { id: Date.now(), videoId: videoId, title: title, addedAt: new Date().toLocaleTimeString() };
        queue.push(song);

        if (!currentSong) {
            playSong(song);
        } else {
            updateQueue();
            pushToServer();
        }
        showToast('"' + title + '" added to the queue!', 'success');
    }

    function extractVideoId(url) {
        const regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    function addSongFromUrl() {
        const input = document.getElementById('url-input');
        const url = input.value.trim();
        const videoId = extractVideoId(url);

        if (videoId) {
            const song = { id: Date.now(), videoId: videoId, title: 'Video ' + videoId, addedAt: new Date().toLocaleTimeString() };
            // Try fetching title
            fetch('/api/video-info?id=' + videoId).then(r => r.json()).then(data => {
                if (data.title) song.title = data.title;
            }).catch(() => {}).finally(() => {
                queue.push(song);
                input.value = '';
                if (!currentSong) { playSong(song); } else { updateQueue(); pushToServer(); }
                showToast('"' + song.title + '" added!', 'success');
            });
        } else {
            showToast('Invalid YouTube URL', 'error');
        }
    }

    // Auto-detect pasted YouTube URLs
    document.getElementById('url-input').addEventListener('paste', function() {
        const input = this;
        setTimeout(() => { if (extractVideoId(input.value.trim())) addSongFromUrl(); }, 50);
    });
    document.getElementById('overlay-url-input').addEventListener('paste', function() {
        const input = this;
        setTimeout(() => { if (extractVideoId(input.value.trim())) overlayAddUrl(); }, 50);
    });

    // ===== Queue =====
    function removeSong(id) {
        queue = queue.filter(function(s) { return s.id !== id; });
        updateQueue();
        pushToServer();
    }

    function updateQueue() {
        const container = document.getElementById('queue-container');
        const count = document.getElementById('queue-count');
        const headerCount = document.getElementById('header-queue-count');
        count.textContent = queue.length;
        headerCount.textContent = queue.length;

        container.innerHTML = '';

        if (queue.length === 0) {
            container.innerHTML = '<div class="text-center py-10 text-gray-500 text-sm">Queue is empty</div>';
        } else {
            queue.forEach(function(song, index) {
                const item = document.createElement('div');
                item.className = 'group relative flex items-center gap-3 p-3 rounded-2xl bg-white/5 border border-white/5 hover:border-[#ff5e62]/30 transition-all';

                const img = document.createElement('img');
                img.src = 'https://img.youtube.com/vi/' + encodeURIComponent(song.videoId) + '/default.jpg';
                img.alt = 'Thumbnail';
                img.className = 'w-12 h-12 rounded-xl object-cover flex-shrink-0';

                const info = document.createElement('div');
                info.className = 'flex-1 min-w-0';

                const titleDiv = document.createElement('h4');
                titleDiv.className = 'text-sm text-white font-semibold truncate';
                titleDiv.textContent = song.title || ('Video ' + song.videoId);

                const metaDiv = document.createElement('p');
                metaDiv.className = 'text-[10px] text-gray-400 truncate';
                metaDiv.textContent = '#' + (index + 1) + ' \u00B7 Added ' + song.addedAt;

                info.appendChild(titleDiv);
                info.appendChild(metaDiv);

                const removeBtn = document.createElement('button');
                removeBtn.className = 'opacity-0 group-hover:opacity-100 text-gray-500 hover:text-[#ff5e62] transition-all flex-shrink-0';
                removeBtn.innerHTML = '<iconify-icon icon="lucide:trash-2" class="text-sm"></iconify-icon>';
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    removeSong(song.id);
                });

                item.appendChild(img);
                item.appendChild(info);
                item.appendChild(removeBtn);
                container.appendChild(item);
            });
        }
    }

    // ===== Chat =====
    // Init name display
    document.getElementById('chat-name-btn').textContent = chatUserName;

    function editChatName() {
        const editor = document.getElementById('chat-name-editor');
        const inputRow = document.getElementById('chat-input-row');
        const nameInput = document.getElementById('chat-name-input');
        editor.classList.remove('hidden');
        inputRow.classList.add('hidden');
        nameInput.value = chatUserName;
        nameInput.focus();
        nameInput.select();
    }

    function saveChatName() {
        const nameInput = document.getElementById('chat-name-input');
        const name = nameInput.value.trim().substring(0, 20);
        if (name) {
            chatUserName = name;
            sessionStorage.setItem('chatName', chatUserName);
            document.getElementById('chat-name-btn').textContent = chatUserName;
            showToast('Name set to "' + chatUserName + '"', 'success');
        }
        document.getElementById('chat-name-editor').classList.add('hidden');
        document.getElementById('chat-input-row').classList.remove('hidden');
    }

    async function sendChat() {
        const input = document.getElementById('chat-input');
        const text = input.value.trim();
        if (!text) return;

        input.value = '';
        input.disabled = true;

        try {
            await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: chatUserName, text: text })
            });
            // Poll immediately to show our message
            await pollChat();
        } catch (error) {
            showToast('Failed to send message', 'error');
        }

        input.disabled = false;
        input.focus();
    }

    async function pollChat() {
        try {
            const response = await fetch('/api/chat?after=' + lastChatId);
            if (!response.ok) return;
            const messages = await response.json();

            if (messages.length > 0) {
                const container = document.getElementById('chat-messages');
                // Clear the "No messages yet" placeholder
                if (lastChatId === 0 && container.querySelector('.text-center')) {
                    container.innerHTML = '';
                }

                messages.forEach(function(msg) {
                    const div = document.createElement('div');
                    div.className = 'flex flex-col gap-0.5';

                    const header = document.createElement('div');
                    header.className = 'flex items-center gap-2';

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'text-[11px] font-bold ' + (msg.name === chatUserName ? 'text-[#ff5e62]' : 'text-[#f5d142]');
                    nameSpan.textContent = msg.name;

                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'text-[9px] text-gray-600';
                    timeSpan.textContent = msg.time;

                    header.appendChild(nameSpan);
                    header.appendChild(timeSpan);

                    const textP = document.createElement('p');
                    textP.className = 'text-xs text-gray-300 break-words';
                    textP.textContent = msg.text;

                    div.appendChild(header);
                    div.appendChild(textP);
                    container.appendChild(div);

                    lastChatId = msg.id;
                });

                // Scroll to bottom
                container.scrollTop = container.scrollHeight;
            }
        } catch (error) {
            console.debug('Chat poll error:', error.message);
        }
    }

    function startChatPoll() {
        chatPollInterval = setInterval(pollChat, 2000);
    }

    // Save chat name to session
    sessionStorage.setItem('chatName', chatUserName);

    // ===== Init =====
    getServerIP().then(() => {
        generateQR();
        syncWithServer();
        startSync();
        pollChat();
        startChatPoll();
    });
</script>
</body>
</html>
